<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wassup chat app</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');
        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: #F8F8F8;
            font-family: 'Roboto', sans-serif;
        }
        section.chat__section {
            width: 800px;
            max-width: 90%;
            background: #fff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .brand {
            padding: 20px;
            background: #f1f1f1;
            display: flex;
            align-items: center;
        }
        .brand h1 {
            text-transform: uppercase;
            font-size: 20px;
            color: #444;
            margin-left: 10px;
        }
        .message__area{
            height: 500px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: auto;
            padding-top: 40px;
        }
        textarea {
            width: 100%;
            border: none;
            padding: 20px;
            font-size: 16px;
            outline: none;
            background: #FBFBFB;
        }

        .message {
            padding: 20px; 
            border-radius: 4px; 
            margin-bottom: 40px;
            max-width: 300px;
            position: relative;
        }
        .incoming {
            background: #8F8BE8;
            color: #fff;  
        }
        .outgoing {
            background: #e9eafd;
            color: #787986;
            margin-left: auto;
        }
        .message h4 {
            position: absolute;
            top: -20px;
            left: 0;
            color: #333;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <section class="chat__section">
        <div class="brand">
            <h1>Chat</h1>
        </div>
        <div class="message__area"></div>
        <div>
            <textarea id="textarea" cols="30" rows="1" placeholder="Write a message..."></textarea>
            <button id="sendButton">Send</button> <!-- Added Send button -->
        </div>
    </section>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.js"></script>
    <script>
        const token = localStorage.getItem("token"); // Retrieve JWT token from local storage
        if (!token) {
            // Redirect to login page if token is not available
            window.location.href = "/api/login";
        }

        const socket = io();

        function decodeJwt(token) {
            const parts = token.split('.');
            const encodedPayload = parts[1];
            const decodedPayload = atob(encodedPayload);
            const payload = JSON.parse(decodedPayload);
            return payload;
          }
        
        // Get username from token
        const payload = decodeJwt(token);
        console.log(payload);
        let textarea = document.querySelector("#textarea");
        let messageArea = document.querySelector(".message__area");

        textarea.addEventListener("keyup", async (e) => {
            if (e.key === "Enter") {
                const message = e.target.value.trim();
                if (message) {
                    // Send message to server for LLM processing with JWT token
                    const response = await sendLLMRequest(message,payload);
        
                    // Append user's original message (optional)
                    appendMessage({ user: payload.username, message }, "outgoing");
        
                    textarea.value = "";
                    scrollToBottom();
                }
            }
        });

        async function sendLLMRequest(message,payload) {
            try {
                const response = await fetch("/api/message", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${token}`, // Include JWT token in request headers
                    },
                    body: JSON.stringify({ message,payload}),
                });

                if (response.ok) {
                    const processedMessage = await response.json();
                    return { user: name, message, processedMessage };
                } else {
                    console.error("Error fetching LLM response:", response.statusText);
                    return { user: name, message };
                }
            } catch (error) {
                console.error("Error sending LLM request:", error);
                return { user: name, message };
            }
        }

        function appendMessage(msg, type) {
            let mainDiv = document.createElement("div");
            let className = type;
            mainDiv.classList.add(className, "message");

            let markup = `
                <h4>${msg.user}</h4>
                <p>${msg.message}</p>
                <p class="processed-message">${msg.processedMessage || ""}</p>`;
            mainDiv.innerHTML = markup;
            messageArea.appendChild(mainDiv);
        }

        function scrollToBottom() {
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        socket.on("message", (msg) => {
            if (msg.processedMessage) {
                appendMessage(msg, "incoming");
            } else {
                appendMessage({ user: msg.user, message: msg.message }, "incoming");
            }
            scrollToBottom();
        });

        // Send button event listener
        const sendButton = document.getElementById("sendButton");
        sendButton.addEventListener("click", async () => {
            const message = textarea.value.trim();
            if (message) {
                // Send message to server for LLM processing with JWT token
                const response = await sendLLMRequest(message);

                // Append user's original message (optional)
                appendMessage({ user: name, message }, "outgoing");

                textarea.value = "";
                scrollToBottom();
            }
        });
    </script>
</body>
</html>
